<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<title>极简通话</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{margin:0;font-family:sans-serif;background:#111;color:#eee;display:flex;flex-direction:column;height:100vh}
  #msg{flex:none;padding:10px;text-align:center;font-size:1.2em}
  video{flex:1;object-fit:cover;background:#000}
  #roomBox{position:fixed;top:10px;left:10px;background:#222;padding:8px;border-radius:4px}
  button{padding:6px 10px;margin-left:6px}
</style>
</head>
<body>
<div id="msg">正在连接…</div>
<video id="local" autoplay muted playsinline></video>
<video id="remote" autoplay playsinline></video>

<div id="roomBox">
  <span id="roomDisplay"></span>
  <button onclick="copyLink()">复制链接</button>
</div>

<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<script>
// ===== 仅用 Cloudflare STUN =====
const iceServers = [{ urls: 'stun:stun.cloudflare.com:3478' }];

const peer        = new Peer({ config: { iceServers } });
const localVideo  = document.getElementById('local');
const remoteVideo = document.getElementById('remote');
const msg         = document.getElementById('msg');
const roomDisplay = document.getElementById('roomDisplay');
let localStream;

// 生成/读取房间号
const roomId = location.hash.slice(1) || (Math.random().toString(36)+'00000000').substr(2,8).toUpperCase();
if (!location.hash) location.hash = roomId;
roomDisplay.textContent = roomId;

// 复制邀请链接
function copyLink() {
  navigator.clipboard.writeText(location.href);
  alert('已复制：'+location.href);
}

// 媒体 & 呼叫
navigator.mediaDevices.getUserMedia({ video: true, audio: true })
  .then(stream => {
    localVideo.srcObject = localStream = stream;

    peer.on('open', id => {
      if (id !== roomId) peer.disconnect();
      if (id === roomId) msg.textContent = '等待对方…';
    });

    peer.on('call', call => {
      call.answer(stream);
      call.on('stream', s => { remoteVideo.srcObject = s; msg.textContent = '已连接'; });
      call.on('close',   () => msg.textContent = '对方已离开');
    });

    if (location.hash.slice(1) && location.hash.slice(1) !== peer.id) {
      const conn = peer.connect(roomId);
      conn.on('open', () => {
        const call = peer.call(roomId, stream);
        call.on('stream', s => { remoteVideo.srcObject = s; msg.textContent = '已连接'; });
        call.on('close',   () => msg.textContent = '对方已离开');
      });
    }
  })
  .catch(e => alert('摄像头权限失败：'+e));
</script>
</body>
</html>
